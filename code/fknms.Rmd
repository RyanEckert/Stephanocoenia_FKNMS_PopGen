---
title: "FKNMS PopGen"
author: "Ryan Eckert"
date: "5/7/2020"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'

---
<a href="https://github.com/RyanEckert/FKNMS" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#2C3E50; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

#### version: `r library(magrittr)` `r Sys.Date() %>% format(format="%B %d, %Y")`

#### [GitHub repository](https://github.com/RyanEckert/FKNMS.git){target="_blank"}

# About this document
***
#### All analyses preformed with R version `r getRversion()`.


# Basic setup of R environment
***

```{r, setup, include = FALSE}
#setup rmarkdown environment first
knitr::opts_chunk$set(warning = FALSE, fig.align = 'left')
knitr::opts_knit$set(root.dir = '../data')
options(width = 88)
```

## Loading required packages
For the following analyses we will require the use of a number of different R packages. We can use the following code to quickly load in the packages and install any packages not previously installed in the R console.

```{r, load packages, include = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
setwd("../data")

if (!require("pacman")) install.packages("pacman")
pacman::p_load("cowplot", "ggrepel", "ggspatial", "paletteer", "patchwork", "rgdal", "rnaturalearth", "sf", "tidyverse")
```
<br>

# Map of study sites

<br>

```{r, map data}
fknmsSites = read.csv("sampleData.csv", header = TRUE)
fknmsSites$depth = factor(fknmsSites$depth, levels = levels(fknmsSites$depth)[c(2,1)])
fknmsSites$reef = factor(fknmsSites$reef, levels = levels(fknmsSites$reef)[c(2, 5, 1, 4, 3)])

fknmsReefs = fknmsSites %>% group_by(reef) %>% summarize(lat = mean(lat), long = mean(long))

fknmsBounds = read.csv("fknmsSPA.csv", header = TRUE)

states = st_as_sf(ne_states(country = "United States of America"))
florida = read_sf("shp/flKeys.shp") %>% st_transform(crs = 4326)
bathy = read_sf("shp/flBathy.shp") %>% st_transform(crs = 4326) %>% subset(subset = DATASET %in% c("fl_shelf", "fl_coast"))

```
<br>

Next we build a hi-res polygon of FL with the study site marked and a zoomed in map of the colony locations. We use `ggspatial` to add a north arrow and scale bar to the main map.
```{r, maps}
floridaMap = ggplot() +
  geom_polypath(data = fknmsBounds[fknmsBounds$type == "Sanctuary",], aes(x = long, y = lat, group = location), alpha = 0.1, fill = "black", color = NA) +
  geom_polypath(data = fknmsBounds[fknmsBounds$location == "FKNMS2",], aes(x = long, y = lat), fill = "aliceblue", color = NA) +
  geom_polypath(data = fknmsBounds, aes(x = long, y = lat, color = type, group = location), fill = NA) +
  scale_fill_manual(values = paletteer_d("wesanderson::Darjeeling1", n = 5, type = "continuous"), name = "Reef") +
  scale_color_manual(values = c("gray30", "goldenrod3"), name = "Boundaries", labels = c("FKNMS", "SPA")) +
  geom_point(data = fknmsReefs, aes(x = long, y = lat, fill = reef), shape = 21, size = 2) +
  geom_sf(data = states, fill = "white", size = 0.25) +
  coord_sf(xlim = c(-88, -79.7), ylim = c(24, 31.3)) +
  scale_x_continuous(breaks = c(seq(-88, -78, by = 2))) +
  scale_y_continuous(breaks = c(seq(24, 32, by = 2))) +
  annotation_scale(location = "bl") +
  annotation_north_arrow(location = "tr", which_north = "true", style = north_arrow_minimal()) +
  theme_bw() +
  theme(plot.title = element_text(size = 9) ,
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_blank(),
        axis.title = element_blank(),
        legend.position = "none")

inset = ggplot() +
  geom_polypath(data = fknmsBounds[fknmsBounds$type == "Sanctuary",], aes(x = long, y = lat, group = location), alpha = 0.1, fill = "black", color = NA) +
   geom_polypath(data = fknmsBounds[fknmsBounds$location == "FKNMS2",], aes(x = long, y = lat), fill = "aliceblue", color = NA) +
  geom_segment(aes(x = -82.9645, xend = -82.4, y = 24.6, yend = 24.6), color = "gray92", size = .55) +
  geom_sf(data = bathy, color = "gray75", size = 0.25) +
  geom_polypath(data = fknmsBounds, aes(x = long, y = lat, color = type, group = location), fill = NA) +
  scale_fill_manual(values = paletteer_d("wesanderson::Darjeeling1", n = 5, type = "continuous"), name = "Reef") +
  scale_color_manual(values = c("gray30", "goldenrod3"), name = "Boundaries", labels = c("FKNMS", "SPA")) +
  geom_point(data = fknmsSites, aes(x = long, y = lat, fill = reef, shape = depth), size = 1.5) +
  geom_sf(data = florida, fill = "white", size = 0.25) +
  scale_shape_manual(values = c(24, 25), name = "Depth") +
  guides(fill = guide_legend(override.aes = list(shape = 22, color = NA, size = 4), order = 1), shape = guide_legend(override.aes = list(size = 3), order = 2), color = guide_legend(override.aes = list(fill = "black", alpha = 0.1), order = 3)) +
  theme_bw() +
  theme(legend.title = element_text(size = 9, face = "bold"),
        axis.title = element_blank(),
        panel.background = element_rect(fill = "aliceblue"),
        legend.text = element_text(size = 9),
        legend.position = "bottom",
        legend.direction = "vertical",
        legend.box = "horizontal")

upperKeys = inset +
  ggtitle("Upper Keys") +
  annotation_scale(location = "bl") +
  coord_sf(xlim = c(-80.35, -80.10), ylim = c(25.1, 25.3)) +
  scale_x_continuous(breaks = c(seq(-80.4, -80.1, by = .1))) +
  scale_y_continuous(breaks = c(seq(25.1, 25.3, by = .1)))

lowerKeys = inset +
  ggtitle("Lower Keys") +
  annotation_scale(location = "bl") +
  coord_sf(xlim = c(-81.7, -81.45), ylim = c(24.45, 24.65)) +
  scale_x_continuous(breaks = c(seq(-81.7, -81.45, by = .1))) +
  scale_y_continuous(breaks = c(seq(24.4, 24.7, by = .1)))

dryTortugas = inset +
  ggtitle("Dry Tortugas") +
  annotation_scale(location = "br") +
  coord_sf(xlim = c(-83.2, -82.95), ylim = c(24.48, 24.68)) +
  scale_x_continuous(breaks = c(seq(-83.2, -82.95, by = .1))) +
  scale_y_continuous(breaks = c(seq(24.4, 24.7, by = .1)))

plotLayout = '
  AAAAAAAAAAABBBBB
  AAAAAAAAAAABBBBB
  AAAAAAAAAAABBBBB
  AAAAAAAAAAABBBBB
  AAAAAAAAAAACCCCC
  AAAAAAAAAAACCCCC
  AAAAAAAAAAACCCCC
  AAAAAAAAAAACCCCC
  #EEEEEEEEE#DDDDD
  #EEEEEEEEE#DDDDD
  #EEEEEEEEE#DDDDD
  #EEEEEEEEE#DDDDD
'

fknmsMap = floridaMap + upperKeys + lowerKeys + dryTortugas + guide_area() +
  plot_annotation(tag_levels = 'a') +
  plot_layout(design = plotLayout, guides = "collect") &
  theme(plot.tag = element_text(face = "bold"),
        plot.title = element_text(face = "bold", size = 9),
        legend.box = "horizontal",
        legend.box.just = "top",
        legend.spacing.x = unit(.1, "cm"),
        axis.ticks = element_line(color = "black"),
        axis.text = element_text(size = 9, color = "black"))

ggsave("../figures/map.tiff", plot = fknmsMap, width = 16, height = 15, units = "cm", dpi = 600)

ggsave("../figures/map.png", plot = fknmsMap, width = 16, height = 15, units = "cm", dpi = 600)

```
![](../figures/map.png)
<br>
